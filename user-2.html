<! DOCTYPE html>

<head>
    <meta charset="utf-8">
    <title>Demo</title>
    <link href='https://api.mapbox.com/mapbox-gl-js/v0.44.0/mapbox-gl.css' rel='stylesheet' />
    <link href="style.css" rel="stylesheet" />
    <script src='https://api.mapbox.com/mapbox-gl-js/v0.44.0/mapbox-gl.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.js"></script>
    <script src="Highmaps-6/code/highcharts.js"></script>
    <script src='Highmaps-6/code/js/modules/map.js'></script>
    <script src="Highmaps-6/code/modules/data.js"></script>
    <script src="https://code.highcharts.com/mapdata/countries/us/us-all.js"></script>
    <script src='jquery-3.3.1.js'></script>

    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://rawgit.com/FabricioRHS/skd3/master/build/sk.d3.min.js"></script>
    <link href="https://rawgit.com/FabricioRHS/skd3/master/build/sk.d3.min.css" rel="stylesheet" type="text/css" />

    <script src="https://d3js.org/d3-color.v1.min.js"></script>
    <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script>
        var yellow = d3.interpolateYlGn(0), // "rgb(255, 255, 229)"
            yellowGreen = d3.interpolateYlGn(0.5), // "rgb(120, 197, 120)"
            green = d3.interpolateYlGn(1); // "rgb(0, 69, 41)"

    </script>

</head>

<body style="background-color: #f6f6f6;">

    <div id="searchBar" class="fixed">
        <p style="padding-left: 15px; margin-top: 13px;">Peet's Coffee and Tea</p>
    </div>
    <div id="dateBar" class="fixed">
        <p style="padding-left: 15px; margin-top: 13px;">Past 5 minutes</p>
    </div>

    <div id="container" class="fixed">
        <div id="tabs" class="fixed">
            <a href="index.html"><h2 style="margin-right: 10px;" class="inline">Footfall</h2></a>
            <a href="behavior.html"><h2 style="margin-right: 10px;"  class="inline">Behavior</h2></a>
            <a href="demo.html"><h2 style="margin-right: 10px;"  class="inline">Demographics</h2></a>
            <a href="user.html" class="active"><h2 style="margin-right: 10px;"  class="inline">User Journey</h2></a>
        </div>

        <div class="fixed" style="left: 40px; top: 160px;">
            <h3>Chains Visited 6 Hours Before</h3></div>
        <div id='chart' class="fixed"></div>

        <div id='chBeforeDiv' class="fixed" style="width: 580px; height: 280px;">
            <h3>Chains Visited 6 Hours Before</h3>
            <canvas id="chBefore" width="580" height="260"></canvas>
        </div>

        <div id='chAfterDiv' class="fixed" style="width: 580px; height: 280px;">
            <h3>Chains Visited 6 Hours After</h3>
            <canvas id="chAfter" width="580" height="260"></canvas>
        </div>

    </div>



    <script src="sankey.js"></script>
    <script>
        var units = "Widgets";

        var margin = {
                top: 10,
                right: 10,
                bottom: 10,
                left: 10
            },
            width = 700 - margin.left - margin.right,
            height = 300 - margin.top - margin.bottom;

        var formatNumber = d3.format(",.0f"), // zero decimal places
            format = function(d) {
                return formatNumber(d) + " " + units;
            },
            color = d3.scaleOrdinal(d3.schemeSet3);

        // append the svg canvas to the page
        var svg = d3.select("#chart").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");

        // Set the sankey diagram properties
        var sankey = d3.sankey()
            .nodeWidth(36)
            .nodePadding(40)
            .size([width, height]);

        var path = sankey.link();

        // load the data (using the timelyportfolio csv method)
        d3.csv("sankey-2.csv", function(error, data) {

            //set up graph in same style as original example but empty
            graph = {
                "nodes": [],
                "links": []
            };

            data.forEach(function(d) {
                graph.nodes.push({
                    "name": d.source
                });
                graph.nodes.push({
                    "name": d.target
                });
                graph.links.push({
                    "source": d.source,
                    "target": d.target,
                    "value": +d.value
                });
            });

            // return only the distinct / unique nodes
            graph.nodes = d3.keys(d3.nest()
                .key(function(d) {
                    return d.name;
                })
                .map(graph.nodes));

            // loop through each link replacing the text with its index from node
            graph.links.forEach(function(d, i) {
                graph.links[i].source = graph.nodes.indexOf(graph.links[i].source);
                graph.links[i].target = graph.nodes.indexOf(graph.links[i].target);
            });

            //now loop through each nodes to make nodes an array of objects
            // rather than an array of strings
            graph.nodes.forEach(function(d, i) {
                graph.nodes[i] = {
                    "name": d
                };
            });

            sankey
                .nodes(graph.nodes)
                .links(graph.links)
                .layout(32);

            // add in the links
            var link = svg.append("g").selectAll(".link")
                .data(graph.links)
                .enter().append("path")
                .attr("class", "link")
                .attr("d", path)
                .style("stroke-width", function(d) {
                    return Math.max(1, d.dy);
                })
                .sort(function(a, b) {
                    return b.dy - a.dy;
                });

            // add the link titles
            link.append("title")
                .text(function(d) {
                    return d.source.name + " â†’ " +
                        d.target.name + "\n" + format(d.value);
                });

            // add in the nodes
            var node = svg.append("g").selectAll(".node")
                .data(graph.nodes)
                .enter().append("g")
                .attr("class", "node")
                .attr("transform", function(d) {
                    return "translate(" + d.x + "," + d.y + ")";
                })
                .call(d3.behavior.drag()
                    .origin(function(d) {
                        return d;
                    })
                    .on("dragstart", function() {
                        this.parentNode.appendChild(this);
                    })
                    .on("drag", dragmove));

            // add the rectangles for the nodes
            node.append("rect")
                .attr("height", function(d) {
                    return d.dy;
                })
                .attr("width", sankey.nodeWidth())
                .style("fill", function(d) {
                    return d.color = color(d.name.replace(/ .*/, ""));
                })
                .style("stroke", function(d) {
                    return d3.rgb(d.color).darker(2);
                })
                .append("title")
                .text(function(d) {
                    return d.name + "\n" + format(d.value);
                });

            // add in the title for the nodes
            node.append("text")
                .attr("x", -6)
                .attr("y", function(d) {
                    return d.dy / 2;
                })
                .attr("dy", ".35em")
                .attr("text-anchor", "end")
                .attr("transform", null)
                .text(function(d) {
                    return d.name;
                })
                .filter(function(d) {
                    return d.x < width / 2;
                })
                .attr("x", 6 + sankey.nodeWidth())
                .attr("text-anchor", "start");

            // the function for moving the nodes
            function dragmove(d) {
                d3.select(this).attr("transform",
                    "translate(" + d.x + "," + (
                        d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))
                    ) + ")");
                sankey.relayout();
                link.attr("d", path);
            }
        });

        //Chains Before
        var chB = document.getElementById("chBefore").getContext('2d');
        var chBef = new Chart(chB, {
            type: 'horizontalBar',
            data: {
                labels: [
                    "Natural Resources Conservation", "Philz Coffee", "Peet\'s Coffee and Tea", "CORT Furniture", "GapBody", "Veggie Grill", "Orchard Supply Hardware", "BevMo!", "Banfield The Pet Hospital", "Travelodge", "Wells Fargo Home Mortgage", "Safeway", "Shred Nations", "Better Homes and Gardens Real Estate"
                ],
                datasets: [{
                    label: 'Peet\'s',
                    data: [77.15472605, 44.91882199, 22.7990929, 14.72859665, 14.4808458, 10.7887397, 9.861539322, 9.531151294, 9.327559402, 7.07700436, 6.397581142, 6.356592317, 6.234389153, 5.994545961],
                    backgroundColor: 'rgba(255, 170, 34, 0.6)',
                    borderColor: 'rgb(255, 170, 34)',
                    borderWidth: 1
                }, ]
            },
            options: {
                scales: {
                    xAxes: [{
                        ticks: {
                            beginAtZero: true
                        },
                        scaleLabel: {
                            display: true,
                            labelString: 'Over/under index',
                        }
                    }],
                    yAxes: [{
                        gridLines: {
                            offsetGridLines: false
                        },
                        ticks: {
                            maxRotation: 0,
                            autoSkip: false,
                            callback: function(value) {
                                return (value.substr(0, 12) + '..'); //truncate
                            },
                        }
                    }]
                },
                tooltips: {
                    enabled: true,
                    mode: 'label',
                    callbacks: {
                        title: function(tooltipItems, data) {
                            var idx = tooltipItems[0].index;
                            return data.labels[idx]; //do something with title
                        },
                    }
                },
                legend: {
                    display: false
                },
            }
        });

        //Chains After
        var chA = document.getElementById("chAfter").getContext('2d');
        var chAf = new Chart(chA, {
            type: 'horizontalBar',
            data: {
                labels: [
                    "Philz Coffee", "Peet\'s Coffee and Tea", "CORT Furniture", "GapBody", "Better Homes and Gardens Real Estate", "Veggie Grill", "Banfield The Pet Hospital", "Orchard Supply Hardware", "BevMo!", "Safeway", "Travelodge", "Wells Fargo Home Mortgage", "The Habit Burger Grill", "Green Burrito"
                ],
                datasets: [{
                    label: 'Peet\'s',
                    data: [41.6680093, 22.7990929, 15.94975935, 14.96165567, 13.72030326, 11.60524217, 10.52222978, 10.17417055, 9.978235849, 6.717507255, 6.560712089, 6.391136114, 6.237579713, 6.073172277],
                    backgroundColor: 'rgba(255, 170, 34, 0.6)',
                    borderColor: 'rgb(255, 170, 34)',
                    borderWidth: 1
                }, ]
            },
            options: {
                scales: {
                    xAxes: [{
                        ticks: {
                            beginAtZero: true
                        },
                        scaleLabel: {
                            display: true,
                            labelString: 'Over/under index',
                        }
                    }],
                    yAxes: [{
                        gridLines: {
                            offsetGridLines: false
                        },
                        ticks: {
                            maxRotation: 0,
                            autoSkip: false,
                            callback: function(value) {
                                return (value.substr(0, 12) + '..'); //truncate
                            },
                        }
                    }]
                },
                tooltips: {
                    enabled: true,
                    mode: 'label',
                    callbacks: {
                        title: function(tooltipItems, data) {
                            var idx = tooltipItems[0].index;
                            return data.labels[idx]; //do something with title
                        },
                    }
                },
                legend: {
                    display: false
                },
            }
        });

    </script>
</body>
